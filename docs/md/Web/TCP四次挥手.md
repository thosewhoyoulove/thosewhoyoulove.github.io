# TCP四次挥手过程

TCP 四次挥手是 TCP 连接关闭的过程，它确保双方都能安全地结束通信。与三次握手不同，四次挥手的发起方和结束方有所不同，具体来说：主动关闭方（也就是请求关闭连接的一方）在流程中扮演了一个更重要的角色，接收方则需要等到所有数据传输完成后才能关闭连接。

四次挥手过程：

1. 主动关闭方(发起方)发送一个 FIN 报文，表示请求关闭连接。
   - 该报文包含：
     - FIN = 1（表示请求关闭连接）。
     - 发起方将 当前序列号（Seq = X） 放在报文中，表明它已经发送完数据，接下来只能接收数据。
   - 发起方进入 **FIN_WAIT_1** 状态，表示它已经发起关闭连接的请求。
2. 接收方接收到 FIN 报文后，发送一个 ACK 确认报文。
   - 该报文包含：
     - ACK = 1（表示确认收到客户端的 FIN 报文）。
     - 确认号 ack = X + 1（表示接收方已经收到客户端的 FIN 报文）。
     - 接收方将 当前序列号（Seq = Y） 放在报文中，表明它已经接收完数据，接下来只能发送数据。
   - 接收方进入 **CLOSE_WAIT** 状态，表示它已经准备好关闭连接。

3. 接收方发送一个 FIN 报文，表示请求关闭连接。
   - 该报文包含：
     - FIN = 1（表示请求关闭连接）。
     - 接收方会为该报文分配一个 序列号（Seq = Z）。
   - 接收方进入 **LAST_ACK** 状态，表示它已发送完所有数据，正在等待客户端的最终确认。

4. 主动关闭方接收到接收方的 FIN 报文后，发送一个 ACK 确认报文。
   - 该报文包含：
     - ACK = 1（表示确认收到接收方的 FIN 报文）。
     - 确认号 ack = Z + 1（表示主动关闭方已经收到接收方的 FIN 报文）。
     - 主动关闭方发送完这个 ACK 后，进入 TIME_WAIT 状态，等待一段时间（通常是 2 * MSL，MSL 是最大段生存时间），确保服务器收到确认的 ACK 后才能完全关闭连接。
   - 接收方收到这个 ACK 后，进入 CLOSED 状态，表示连接已完全关闭。
   - 主动关闭方在 TIME_WAIT 状态等待2MSL后，也进入 CLOSED 状态，表示连接已完全关闭。

四次挥手示意图：

```pgsql
  Client                             Server
    | --- FIN (Seq=X) --------------> |
    |                                 |
    | <--- ACK (Seq=Y, Ack=X+1) ---> |
    |                                 |
    | --- FIN (Seq=Z) --------------> |
    |                                 |
    | <--- ACK (Seq=X+1, Ack=Z+1) ---> |
    |                                 |
    [连接关闭]                 [连接关闭]
```

```plaintext
tips

MSL(Maximum Segment Lifetime) : 一个片段在网络中最大的存活时间，2MSL 就是一个发送和一个回复所需的最大时间。如果直到 2MSL，Client 都没有再次收到 FIN，那么 Client 推断 ACK 已经被成功接收，则结束 TCP 连接。
```
